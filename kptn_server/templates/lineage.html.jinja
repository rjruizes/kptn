{% if not is_fragment %}<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kptn Lineage</title>
    <script src="{{ static_prefix }}/alpine.min.js" defer></script>
{% else %}
<div id="kptn-lineage-fragment">
{% endif %}
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.08), transparent 30%),
                        radial-gradient(circle at 75% 35%, rgba(16, 185, 129, 0.08), transparent 25%),
                        radial-gradient(circle at 50% 80%, rgba(236, 72, 153, 0.08), transparent 20%),
                        #0b1021;
            color: #e2e8f0;
        }
        .container {
            padding: 16px;
        }
        .kptn-toolbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            position: sticky;
            top: 0;
            padding-top: 4px;
            background: linear-gradient(180deg, rgba(11,16,33,0.85) 0%, rgba(11,16,33,0) 100%);
        }
        .kptn-preview-all {
            border: 1px solid rgba(226,232,240,0.1);
            background: rgba(255,255,255,0.06);
            color: #e2e8f0;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
        }
        .kptn-preview-all:hover {
            background: rgba(255,255,255,0.12);
            border-color: rgba(226,232,240,0.2);
            color: #fbbf24;
        }
        .table-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .kptn-open-file, .kptn-open-table, .kptn-toggle-sql {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: none;
            background: rgba(255,255,255,0.04);
            color: #e2e8f0;
            cursor: pointer;
            padding: 2px;
            transition: background 0.15s ease, color 0.15s ease;
        }
        .kptn-open-file:hover, .kptn-open-table:hover, .kptn-toggle-sql:hover {
            background: rgba(255,255,255,0.1);
            color: #fbbf24;
        }
        .kptn-open-file svg, .kptn-open-table svg, .kptn-toggle-sql svg {
            width: 16px;
            height: 16px;
        }
        .kptn-preview {
            max-width: 100%;
            width: 100%;
            display: block;
            overflow-x: auto;
            margin-top: 6px;
        }
        .preview-table {
            width: max-content;
            min-width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }
        .preview-table th, .preview-table td {
            border: 1px solid rgba(226,232,240,0.2);
            padding: 6px 8px;
            font-size: 12px;
            color: #e2e8f0;
            min-width: 110px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .preview-table th {
            background: rgba(255,255,255,0.05);
            color: #cbd5e1;
            text-align: left;
        }
        .preview-status {
            font-size: 13px;
            color: #cbd5e1;
        }
        .kptn-sql-input {
            display: none;
            align-items: center;
            gap: 4px;
            margin-left: 4px;
        }
        .kptn-sql-input.is-visible {
            display: inline-flex;
        }
        .kptn-sql-input input {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.08);
            color: #cbd5e1;
            border-radius: 4px;
            padding: 2px 4px;
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
            font-size: 10px;
            height: 18px;
            min-width: 80px;
            max-width: 180px;
            box-sizing: border-box;
        }
        .kptn-sql-input input:focus {
            outline: 1px solid rgba(56,189,248,0.4);
            border-color: rgba(56,189,248,0.3);
        }
    </style>
{% if not is_fragment %}
</head>
<body>
{% endif %}
    <div class="container" id="kptn-lineage-root">
        <div class="kptn-toolbar">
            <button id="kptn-preview-all" class="kptn-preview-all" type="button">Preview All</button>
        </div>
        {{ lineage_html | safe }}
    </div>

    <script>
    (function() {
        function initLineage() {
            const vscode = typeof acquireVsCodeApi === 'function' ? acquireVsCodeApi() : null;
            const tableMap = {{ table_map_json | safe }};
            const configPath = {{ config_path_json | safe }};
            const baseUrl = {{ base_url_json | safe }};
            const openSvg = '<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2.5h7l3 3v8H3z"/><path d="M10 2.5v3h3"/><path d="M7 6 5 8l2 2"/><path d="M9 10l2-2-2-2"/></svg>';
            const tableSvg = '<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M6.25 4.75 11.25 8l-5 3.25z" fill="currentColor" stroke="none"/></svg>';
            const filterSvg = '<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 3.5h11l-4 4v3l-3 1v-4z"/></svg>';
            const DEFAULT_LIMIT = 50;

            function normalize(name) {
                return (name || '').trim().replace(/^[^:]*:\/\//, '').split('.').slice(-1)[0]?.toLowerCase() || '';
            }
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            function buildPreviewSql(name, filterClause) {
                const parts = (name || '').split('.').map((segment) => `"${segment.replace(/"/g, '""')}"`).filter(Boolean);
                const qualified = parts.length ? parts.join('.') : '""';
                const rawFilter = typeof filterClause === 'string' ? filterClause : '';
                const trimmedFilter = rawFilter.trim();
                const hasFilter = trimmedFilter && trimmedFilter.toUpperCase() !== 'WHERE';
                const filterSegment = hasFilter ? ` ${trimmedFilter}` : '';
                return `SELECT * FROM ${qualified}${filterSegment} LIMIT ${DEFAULT_LIMIT}`;
            }
            function findTableElement(tableName) {
                const target = (tableName || '').trim().toLowerCase();
                if (!target) return null;
                const tables = document.querySelectorAll('.table');
                for (const table of tables) {
                    if (!(table instanceof HTMLElement)) continue;
                    const nameEl = table.querySelector('.table-name');
                    if (!(nameEl instanceof HTMLElement)) continue;
                    const textNode = Array.from(nameEl.childNodes).find((node) => node.nodeType === Node.TEXT_NODE);
                    const label = (textNode?.textContent || nameEl.textContent || '').trim().toLowerCase();
                    if (label === target) {
                        return table;
                    }
                }
                return null;
            }
            function formatCellValue(value) {
                if (value === null || value === undefined) return 'null';
                if (typeof value === 'object') {
                    try {
                        return JSON.stringify(value);
                    } catch {
                        return String(value);
                    }
                }
                return String(value);
            }
            function renderPreview(tableName, payload) {
                const tableEl = findTableElement(tableName);
                if (!tableEl) return;

                // Check for error message
                if (payload?.message) {
                    const previewSlot = ensurePreviewSlot(tableEl);
                    if (previewSlot) {
                        previewSlot.innerHTML = `<p class="preview-status" style="color: #fca5a5;">${escapeHtml(payload.message)}</p>`;
                    }
                    refreshConnections();
                    return;
                }

                const columns = Array.isArray(payload?.columns) ? payload.columns : [];
                const row = Array.isArray(payload?.row) ? payload.row : [];
                if (!columns.length || !row.length) {
                    refreshConnections();
                    return;
                }

                // Clear any loading message
                const previewSlot = ensurePreviewSlot(tableEl);
                if (previewSlot) {
                    previewSlot.innerHTML = '';
                }

                const tableHost = previewSlot || tableEl;
                let previewTable = tableHost.querySelector('table.columns');
                if (!(previewTable instanceof HTMLTableElement)) {
                    previewTable = document.createElement('table');
                    previewTable.className = 'columns preview-table';
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    columns.forEach((column) => {
                        const th = document.createElement('th');
                        th.className = 'column';
                        th.textContent = String(column);
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    previewTable.appendChild(thead);
                    tableHost.appendChild(previewTable);
                }

                let tbody = previewTable.querySelector('tbody');
                if (!(tbody instanceof HTMLTableSectionElement)) {
                    tbody = document.createElement('tbody');
                    previewTable.appendChild(tbody);
                }
                tbody.innerHTML = '';
                tbody.className = 'preview-body';
                const dataRow = document.createElement('tr');
                columns.forEach((_, index) => {
                    const td = document.createElement('td');
                    td.textContent = formatCellValue(index < row.length ? row[index] : null);
                    dataRow.appendChild(td);
                });
                tbody.appendChild(dataRow);

                refreshConnections();
            }
            function refreshConnections() {
                if (typeof updateConnectionPaths === 'function') {
                    updateConnectionPaths();
                } else {
                    window.dispatchEvent(new Event('resize'));
                }
            }
            function ensurePreviewSlot(tableEl) {
                if (!(tableEl instanceof HTMLElement)) return null;
                let slot = tableEl.querySelector('.kptn-preview');
                if (!(slot instanceof HTMLElement)) {
                    slot = document.createElement('div');
                    slot.className = 'kptn-preview';
                    tableEl.appendChild(slot);
                }
                return slot;
            }
            async function loadTablePreview(name, path) {
                await loadTablePreviewWithSql(name, path, null);
            }
            async function loadTablePreviewWithSql(name, path, sqlOverride) {
                const tableEl = findTableElement(name);
                const previewSlot = ensurePreviewSlot(tableEl);
                const sql = typeof sqlOverride === 'string' && sqlOverride.trim() ? sqlOverride : buildPreviewSql(name);
                if (vscode) {
                    vscode.postMessage({ type: 'tableMeta', table: name, path: path || null, sql });
                    return;
                }
                try {
                    const response = await fetch(`${baseUrl || ''}/table-preview-query`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ configPath, table: name, sql }),
                    });
                    const payload = await response.json();
                    renderPreview(name, payload);
                } catch (error) {
                    console.error('Unable to fetch table preview', error);
                    if (previewSlot) {
                        previewSlot.innerHTML = `<p class="preview-status" style="color: #fca5a5;">Error: ${escapeHtml(error.message || 'Unable to fetch table preview')}</p>`;
                    }
                }
            }
            function ensureButtons() {
                document.querySelectorAll('.table-name').forEach((nameEl) => {
                    if (!(nameEl instanceof HTMLElement)) return;
                    const hasOpen = nameEl.querySelector('.kptn-open-file');
                    const hasMeta = nameEl.querySelector('.kptn-open-table');
                    const hasFilterToggle = nameEl.querySelector('.kptn-toggle-sql');
                    let sqlContainer = nameEl.querySelector('.kptn-sql-input');
                    let sqlInput = sqlContainer ? sqlContainer.querySelector('input') : null;
                    const textNode = Array.from(nameEl.childNodes).find((node) => node.nodeType === Node.TEXT_NODE);
                    const name = (textNode?.textContent || nameEl.textContent || '').trim();
                    const key = normalize(name);
                    const path = tableMap[key];
                    const tableEl = nameEl.closest('.table');
                    const previewSlot = ensurePreviewSlot(tableEl);
                    const defaultSql = buildPreviewSql(name);
                    const defaultFilterValue = 'WHERE ';
                    let metaBtn = nameEl.querySelector('.kptn-open-table');

                    function bindInputHandlers(inputEl) {
                        if (!inputEl || inputEl.dataset.kptnBound === '1') return;
                        inputEl.addEventListener('click', (event) => event.stopPropagation());
                        inputEl.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                event.stopPropagation();
                                runPreview();
                            }
                        });
                        inputEl.dataset.kptnBound = '1';
                    }

                    const runPreview = () => {
                        if (previewSlot) {
                            previewSlot.innerHTML = '<p class="preview-status">Loading table details...</p>';
                        } else {
                            renderPreview(name, { table: name, message: 'Loading table details...' });
                        }
                        const sqlValue = sqlInput ? buildPreviewSql(name, sqlInput.value) : defaultSql;
                        loadTablePreviewWithSql(name, path || null, sqlValue);
                    };

                    if (!hasOpen) {
                        const openBtn = document.createElement('button');
                        openBtn.className = 'kptn-open-file';
                        openBtn.type = 'button';
                        openBtn.title = vscode ? 'Open source' : 'Open source (VS Code only)';
                        openBtn.innerHTML = openSvg;
                        openBtn.addEventListener('click', (event) => {
                            event.stopPropagation();
                            if (vscode && path) {
                                vscode.postMessage({ type: 'openFile', path });
                            } else if (vscode && !path) {
                                vscode.postMessage({ type: 'openFileMissing', table: name });
                            }
                        });
                        nameEl.appendChild(openBtn);
                    }

                    if (!sqlContainer) {
                        sqlContainer = document.createElement('div');
                        sqlContainer.className = 'kptn-sql-input';
                        sqlInput = document.createElement('input');
                        sqlInput.type = 'text';
                        sqlInput.className = 'kptn-sql-input-field';
                        sqlInput.spellcheck = false;
                        sqlInput.value = defaultFilterValue;
                        sqlInput.title = 'Add a WHERE clause for preview';
                        bindInputHandlers(sqlInput);
                        sqlContainer.appendChild(sqlInput);
                        nameEl.appendChild(sqlContainer);
                    } else if (!sqlInput) {
                        sqlInput = document.createElement('input');
                        sqlInput.type = 'text';
                        sqlInput.className = 'kptn-sql-input-field';
                        sqlInput.spellcheck = false;
                        sqlInput.value = defaultFilterValue;
                        sqlInput.title = 'Add a WHERE clause for preview';
                        bindInputHandlers(sqlInput);
                        sqlContainer.appendChild(sqlInput);
                    } else {
                        bindInputHandlers(sqlInput);
                    }

                    if (!hasFilterToggle) {
                        const filterBtn = document.createElement('button');
                        filterBtn.className = 'kptn-toggle-sql';
                        filterBtn.type = 'button';
                        filterBtn.title = 'Toggle SQL filter';
                        filterBtn.innerHTML = filterSvg;
                        filterBtn.addEventListener('click', (event) => {
                            event.stopPropagation();
                            if (sqlContainer) {
                                sqlContainer.classList.toggle('is-visible');
                                if (sqlContainer.classList.contains('is-visible') && sqlInput) {
                                    sqlInput.focus();
                                    const length = sqlInput.value.length;
                                    sqlInput.setSelectionRange(length, length);
                                }
                            }
                        });
                        nameEl.appendChild(filterBtn);
                    }

                    if (!hasMeta) {
                        metaBtn = document.createElement('button');
                        metaBtn.className = 'kptn-open-table';
                        metaBtn.type = 'button';
                        metaBtn.title = 'Table details';
                        metaBtn.innerHTML = tableSvg;
                        metaBtn.addEventListener('click', (event) => {
                            event.stopPropagation();
                            runPreview();
                        });
                        metaBtn.dataset.kptnBound = '1';
                        nameEl.appendChild(metaBtn);
                    } else if (metaBtn && metaBtn.dataset.kptnBound !== '1') {
                        metaBtn.addEventListener('click', (event) => {
                            event.stopPropagation();
                            runPreview();
                        });
                        metaBtn.dataset.kptnBound = '1';
                    }
                });
                refreshConnections();
            }

            function previewAllTables() {
                const metaButtons = Array.from(document.querySelectorAll('.kptn-open-table'));
                metaButtons.forEach((btn) => {
                    if (btn instanceof HTMLElement) {
                        btn.click();
                    }
                });
            }

            function wirePreviewAll() {
                const previewAllBtn = document.getElementById('kptn-preview-all');
                if (!(previewAllBtn instanceof HTMLButtonElement) || previewAllBtn.dataset.kptnBound === '1') {
                    return;
                }
                previewAllBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    previewAllTables();
                });
                previewAllBtn.dataset.kptnBound = '1';
            }

            ensureButtons();
            wirePreviewAll();

            if (vscode) {
                window.addEventListener('message', (event) => {
                    const payload = event.data;
                    if (!payload || payload.type !== 'tablePreview') {
                        return;
                    }
                    renderPreview(payload.table, payload);
                });
            }

            document.addEventListener('mouseover', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) return;
                const tableEl = target.closest('.table');
                if (!tableEl) return;
                const nameEl = tableEl.querySelector('.table-name');
                const name = nameEl ? nameEl.textContent || '' : '';
                const key = normalize(name);
                const path = tableMap[key];
                if (vscode && path) {
                    vscode.postMessage({ type: 'hoverFile', path });
                }
            });

            document.addEventListener('mouseout', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) return;
                if (!event.relatedTarget || !(event.relatedTarget instanceof HTMLElement)) {
                    return;
                }
                const leavingTable = target.closest('.table') && !event.relatedTarget.closest('.table');
                if (leavingTable && vscode) {
                    vscode.postMessage({ type: 'hoverExit' });
                }
            });
        }

        window.initLineage = initLineage;
        initLineage();
    })();
    </script>
{% if not is_fragment %}
</body>
</html>
{% else %}
</div>
{% endif %}
