{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "kptn Configuration",
  "description": "Schema for kptn.yaml configuration file",
  "type": "object",
  "required": ["settings", "graphs", "tasks"],
  "properties": {
    "settings": {
      "type": "object",
      "description": "Project settings and directories",
      "required": ["flows_dir", "flow_type"],
      "properties": {
        "flows_dir": {
          "type": "string",
          "description": "Directory where generated workflow files (.py) will be placed"
        },
        "py_tasks_dir": {
          "description": "Directory or directories containing Python task code (.py files)",
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              },
              "minItems": 1
            }
          ]
        },
        "r_tasks_dir": {
          "description": "Directory or directories containing R task code (.R files)",
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              },
              "minItems": 1
            }
          ]
        },
        "duckdb_tasks_dir": {
          "type": "string",
          "description": "Directory containing DuckDB SQL scripts (.sql files)"
        },
        "flow_type": {
          "type": "string",
          "enum": ["vanilla", "prefect", "stepfunctions"],
          "description": "Workflow framework type: vanilla (plain Python), prefect, or stepfunctions (AWS Step Functions)"
        },
        "imports_slot": {
          "type": "string",
          "description": "Raw snippet inserted near the top of generated flows for custom imports or setup commands"
        },
        "db": {
          "type": "string",
          "description": "Database type for caching (e.g., sqlite, dynamodb)"
        }
      },
      "additionalProperties": false
    },
    "config": {
      "type": "object",
      "description": "Optional global configuration key-value pairs accessible to all tasks",
      "additionalProperties": true
    },
    "graphs": {
      "type": "object",
      "description": "Workflow graph definitions",
      "minProperties": 1,
      "additionalProperties": {
        "type": "object",
        "required": ["tasks"],
        "properties": {
          "tasks": {
            "type": "object",
            "description": "Task dependency graph where keys are task names and values define dependencies",
            "additionalProperties": {
              "oneOf": [
                {
                  "type": "null",
                  "description": "No dependencies"
                },
                {
                  "type": "string",
                  "description": "Single task dependency"
                },
                {
                  "type": "array",
                  "items": {
                    "type": "string"
                  },
                  "description": "Multiple task dependencies"
                }
              ]
            }
          }
        },
        "additionalProperties": false
      }
    },
    "tasks": {
      "type": "object",
      "description": "Task definitions and configuration",
      "minProperties": 1,
      "additionalProperties": {
        "type": "object",
        "required": ["file"],
        "properties": {
          "file": {
            "type": "string",
            "description": "Path to task code file. Can optionally specify function name with colon separator (e.g., 'task.py:function_name')"
          },
          "outputs": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "List of output artifacts. Supports templates like 'output_${variable}.csv' or URIs like 'duckdb://main.table'"
          },
          "cache_result": {
            "type": "boolean",
            "description": "Whether to cache the result of this task"
          },
          "iterable_item": {
            "type": "string",
            "description": "Variable name(s) that this task yields for iteration. Use comma-separated for multiple (e.g., 'item1,item2')"
          },
          "prefix_args": {
            "type": "string",
            "description": "Arguments inserted before the `Rscript` invocation (e.g., 'timeout --verbose 1h')"
          },
          "cli_args": {
            "type": "string",
            "description": "Arguments appended after the script path when running the task (supports templating like '${EST_NUM}')"
          },
          "map_over": {
            "type": "string",
            "description": "Variable name(s) to map this task over from a previous task. Use comma-separated for multiple (e.g., 'item1,item2')"
          },
          "bundle_size": {
            "type": "integer",
            "minimum": 1,
            "description": "Number of items to bundle together when mapping over iterables"
          },
          "group_size": {
            "type": "integer",
            "minimum": 1,
            "description": "Number of items to group together when mapping over iterables"
          },
          "logs": {
            "type": "string",
            "description": "Template for log file paths. Supports variable interpolation (e.g., '${item1}_${item2}.log')"
          },
          "compute": {
            "type": "object",
            "description": "Required compute resources for running the task",
            "properties": {
              "cpu": {
                "type": "integer",
                "description": "CPU units for ECS task (256 = 0.25 vCPU)"
              },
              "memory": {
                "type": "integer",
                "description": "Memory in MB for ECS task"
              }
            },
            "additionalProperties": false
          }
        },
        "additionalProperties": false
      }
    }
  },
  "additionalProperties": false
}
