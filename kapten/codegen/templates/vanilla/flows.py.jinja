{% import "macros.jinja" as macros %}
import argparse
import sys
from pathlib import Path
from typing import Literal, Never

from kapten.caching.submit import submit
{# from kapten.deploy.storage_key import read_branch_storage_key #}
from kapten.util.pipeline_config import PipelineConfig, get_storage_key

# Add the tasks directory to sys.path to enable imports
tasks_path = Path(__file__).parent / "{{ rel_py_tasks_dir }}"
if tasks_path.parent not in [Path(p) for p in sys.path]:
    sys.path.insert(0, str(tasks_path.parent))
import {{ rel_py_tasks_dir.split('/')[-1] }} as tasks

TaskListChoices = list[Literal[{% for name in task_names -%}"{{name}}",{% endfor %}]]|list[Never]
VALID_TASKS: set[str] = { {% for name in task_names %}"{{ name }}"{% if not loop.last %}, {% endif %}{% endfor %} }

def {{pipeline_name}}(pipeline_config: PipelineConfig, task_list: TaskListChoices = [], ignore_cache: bool = False):
    {% for name in task_names -%}
    {# {{ macros.submit(name, deps_lookup[name], python_task_names) }} #}
    {{ macros.submit(name, deps_lookup[name], python_task_names) }}
    {%- endfor %}


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Run the pipeline")
    parser.add_argument(
        "-f",
        "--force",
        action="store_true",
        dest="force",
        help="Ignore cached results and force all tasks to run",
    )
    parser.add_argument(
        "tasks",
        nargs="?",
        default="",
        help=(
            "Optional comma-separated list of task names to run; "
            "runs all tasks when omitted"
        ),
    )
    args, _ = parser.parse_known_args()
    {# 
    IMAGE=image,
    BRANCH=branch,
    STORAGE_KEY=possible_storage_key,
    PIPELINE_NAME="srs",
    PY_MODULE_PATH=tasks.__name__,
    R_TASKS_DIR_PATH="/code",
        #}
    tasks_config_path = Path(__file__).parent / "{{ rel_tasks_conf_path }}"
    pipeline_config = PipelineConfig(
        TASKS_CONFIG_PATH=str(tasks_config_path),
        PIPELINE_NAME="{{pipeline_name}}",
        PY_MODULE_PATH=tasks.__name__,{% if r_tasks_dir %}
        R_TASKS_DIR_PATH=str(Path(__file__).parent / "{{ rel_r_tasks_dir }}"),{% endif %}
    )
    raw_task_list = args.tasks
    task_list = (
        [task.strip() for task in raw_task_list.split(",") if task.strip()]
        if raw_task_list
        else []
    )
    if task_list:
        invalid_tasks = [task for task in task_list if task not in VALID_TASKS]
        if invalid_tasks:
            parser.error(
                "Invalid task(s): " + ", ".join(invalid_tasks) + ". "
                "Expected one of: " + ", ".join(sorted(VALID_TASKS))
            )
    {{pipeline_name}}(
        pipeline_config,
        task_list=task_list,
        ignore_cache=args.force,
    )
